<powershell>
# all logging settings are here on top
$logFile = "e:\log-$(gc env:computername).log"
$logLevel = "DEBUG" # ("DEBUG","INFO","WARN","ERROR","FATAL")
$logSize = 1mb # 30kb
$logCount = 10
$regPath = "HKLM:\Software\TARS"
# end of settings

Function Write-Log-Line ($line) {
    Add-Content $logFile -Value $Line
    Write-Host $Line
}

Function Write-Log-Entry {
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]
    $Message,
    
    [Parameter(Mandatory=$False)]
    [String]
    $Level = "DEBUG"
    )

    $levels = ("DEBUG","INFO","WARN","ERROR","FATAL")
    $logLevelPos = [array]::IndexOf($levels, $logLevel)
    $levelPos = [array]::IndexOf($levels, $Level)
    $Stamp = (Get-Date).toString("yyyy/MM/dd HH:mm:ss:fff")

    if ($logLevelPos -lt 0){
        Write-Log-Line "$Stamp ERROR Wrong logLevel configuration [$logLevel]"
    }
    
    if ($levelPos -lt 0){
        Write-Log-Line "$Stamp ERROR Wrong log level parameter [$Level]"
    }

    # if level parameter is wrong or configuration is wrong I still want to see the 
    # message in log
    if ($levelPos -lt $logLevelPos -and $levelPos -ge 0 -and $logLevelPos -ge 0){
        return
    }

    $Line = "$Stamp $Level $Message"
    Write-Log-Line $Line
}

# Remove MQ Failover for nonProd envs
Write-Log-Line "Running UserData script"
Write-Log-Line "Env is [${ENVIRONMENT}]"
if (-Not ("${ENVIRONMENT}" -eq "prod" -Or "${ENVIRONMENT}" -eq "prep")) {
  ((Get-Content -path C:\opt\wildfly\jboss.properties -Raw) -replace "failover:\(ssl://tars-awsmq-1:61617,ssl://tars-awsmq-2:61617\)\?randomize=false", "ssl://tars-awsmq-1:61617" | Set-Content -Path C:\opt\wildfly\jboss.properties)
}

# Create the reg path if it doesn't exist
if (-Not (Test-Path $regPath)) {
  New-Item -Path $regPath -Force | Out-Null 
}

# Stage 1 - Join the domain
if (-Not (Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain) {
  Write-Log-Entry "Stage 1 - Join Domain" "INFO"
  #Retrieve the AWS instance ID, keep trying until the metadata is available
  $instanceID = "null"
  while ($instanceID -NotLike "i-*") {
    Start-Sleep -s 3
    $instanceID = invoke-restmethod -uri http://169.254.169.254/latest/meta-data/instance-id
  }

  #Set DNS Search suffix
  Write-Log-Entry "Stage 1 - Set dns search suffix" "INFO"
  Set-DnsClientGlobalSetting -SuffixSearchList @("${SEARCH_SUFFIX}","dsa.gsi.gov.uk","eu-west-1.ec2-utilities.amazonaws.com","us-east-1.ec2-utilities.amazonaws.com","eu-west-1.compute.internal")

  # set dns to vpc dns via dhcp
  Write-Log-Entry "Stage 1 - Set dns servers to DHCP settings" "INFO"
  Get-NetAdapter | Set-DnsClientServerAddress -ResetServerAddresses

  Write-Log-Entry "Stage 1 - Getting Parameter Values from Parameter Store" "INFO"
  Try {
    Write-Log-Entry "Stage 1 - Getting AD-DNS-List Parameter Value from Parameter Store" "INFO"
    $dnslist = (Get-SSMParameterValue -Name "AD-DNS-List").Parameters[0].Value
    Write-Log-Entry "Stage 1 - Successfully retrieved AD-DNS-List Parameter Value from Parameter Store" "INFO"
  }
  Catch {
    Write-Log-Entry "Stage 1 - Failed to get AD-DNS-List Parameter Value from Parameter Store" "ERROR"
  }


  # Get Domain and OU information that stored in the ssm parameter store
  Try {
    Write-Log-Entry "Stage 1 - Getting AD-domainName Parameter Value from Parameter Store" "INFO"
    $DomainName = (Get-SSMParameterValue -Name AD-domainName).Parameters[0].Value
    Write-Log-Entry "Stage 1 - Successfully retrieved AD-domainName Parameter Value from Parameter Store" "INFO"
  }
  Catch {
    Write-Log-Entry "Stage 1 - Failed to get AD-domainName Parameter Value from Parameter Store" "ERROR"
  }

  Try {
    Write-Log-Entry "Stage 1 - Getting AD-Base-OU Parameter Value from Parameter Store" "INFO"
    $BaseOU = (Get-SSMParameterValue -Name AD-Base-OU).Parameters[0].Value
    Write-Log-Entry "Stage 1 - Successfully retrieved AD-Base-OU Parameter Value from Parameter Store" "INFO"
  }
  Catch {
    Write-Log-Entry "Stage 1 - Failed to get AD-Base-OU Parameter Value from Parameter Store" "ERROR"
  }

  # Get AD credentials that are stored in the ssm parameter store
  Try {
    Write-Log-Entry "Stage 1 - Getting AD-domainpassword Value from Parameter Store" "INFO"
    $username = $DomainName + "\" + (Get-SSMParameterValue -Name AD-domainJoinUserName).Parameters[0].Value
    $password = (Get-SSMParameterValue -Name AD-domainpassword -WithDecryption $True).Parameters[0].Value |
                  ConvertTo-SecureString -asPlainText -Force
    Write-Log-Entry "Stage 1 - Successfully retrieved AD-domainpassword Value from Parameter Store" "INFO"
  }
  Catch {
    Write-Log-Entry "Stage 1 - Failed to get AD-domainpassword Value from Parameter Store" "ERROR"
  }

  # Create PS credential from previously pulling in the credentials from the ssm parameter store
  $cred = New-Object System.Management.Automation.PSCredential($username,$password)

  #Set DNS servers
  $dnsIp = Get-DnsClientServerAddress | Select-Object –ExpandProperty ServerAddresses -Unique -First 1
  Write-Log-Entry "Stage 1 - DNS IP before $${dnsIp}" "INFO"

  Write-Log-Entry "Stage 1 - DNS list $${dnslist}" "INFO"
  Get-NetAdapter | Set-DnsClientServerAddress -ServerAddresses $dnslist

  $dnsIp = Get-DnsClientServerAddress | Select-Object –ExpandProperty ServerAddresses -Unique -First 1
  Write-Log-Entry "Stage 1 - DNS IP after $${dnsIp}" "INFO"


  #Set DNS Search suffix
  #Set-DnsClientGlobalSetting -SuffixSearchList @("${SEARCH_SUFFIX}","dsa.gsi.gov.uk","eu-west-1.ec2-utilities.amazonaws.com","us-east-1.ec2-utilities.amazonaws.com","eu-west-1.compute.internal")

  Try {
      #Join-Machine to AD Domain
      Write-Log-Entry "Stage 1 - Attempting to join domain" "INFO"
      Add-Computer -Domain $DomainName -Credential $cred -OUPath $BaseOU  -ErrorAction 'Stop' -Options "JoinWithNewName, AccountCreate"

      Write-Verbose -Message "Succesfully joined domain."
      Write-Log-Entry "Stage 1 - Successfully joined domain" "INFO"
      Write-Log-Entry "Stage 1 - Re-run userdata" "INFO"
      C:\ProgramData\Amazon\EC2-Windows\Launch\Scripts\InitializeInstance.ps1 -Schedule

      Write-Log-Entry "Stage 1 - Reboot" "INFO"

      Restart-Computer -Force
  }

  Catch{
      Write-Host $_.Exception | Out-File c:\error-joindomain.txt -Append
      Write-Log-Entry "Stage 1 - Join Domain failed, reverting to using R53 DNS" "INFO"
      # Update the DNS IP so that it reverts back to R53
      Get-NetAdapter | Set-DnsClientServerAddress -ResetServerAddresses
  }
} else {
  Write-Log-Entry "Stage 1 - Join Domain skipped" "INFO"
}


# Stage 2 - Install OMS agent, only if we joined the domain
if (-Not (Get-ItemProperty -Path $regPath -Name "OMS" -ErrorAction SilentlyContinue) -and ((Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain)) {
  Write-Log-Entry "Stage 4 - Install OMS agent" "INFO"
  # Install OMS agent by copying locally and running
  try {
  $destinationDirectory = "E:\MMASetup-AMD64.exe"
  $WorkSpaceID = "87fd425e-640a-4c76-a703-d756b2bf7450"
  $URL = "http://download.microsoft.com/download/1/5/E/15E274B9-F9E2-42AE-86EC-AC988F7631A0/MMASetup-AMD64.exe"
  $WorkSpaceKey = "9EFWl4gvQZGtfKR5UjUeBe5c9yw6jQ+fPuZ9MhKc6h8+dfNl/JLxWNi1LmgWuqlakd6iMxy0phpwqJQvbp8OGg=="
  $ArgumentList = '/C:"setup.exe /qn AcceptEndUserLicenseAgreement=1 ADD_OPINSIGHTS_WORKSPACE=1 '+  "OPINSIGHTS_WORKSPACE_ID=$WorkspaceID " + "OPINSIGHTS_WORKSPACE_KEY=$WorkSpaceKey " +'"'
  ## Download latest OMS Agent from the Web
  Invoke-WebRequest -Uri $URl -OutFile $destinationDirectory | Out-Null
  ## Install the agent
  Start-Process -FilePath 'E:\MMASetup-AMD64.exe' -ArgumentList $ArgumentList  -Wait
  Write-Log-Entry "Stage 2 - Installed OMS OK" "INFO"
  # Add a reg key to show we installed ok
  New-ItemProperty -Path $regPath -Name "OMS" -PropertyType "DWORD" -Value 1  | Out-Null 
  }
  catch {
          Write-Warning "Error with OMS Agent install"
          Continue
  }
} else {
  Write-Log-Entry "Stage 2 - Install OMS agent skipped" "INFO"
}
# Configure Cloudwatch logging
$xDATE = Get-Date
$logFile = "C:\Program Files\Amazon\AmazonCloudWatchAgent\cw-log-$(gc env:computername).log"
$cwfile = "C:\Program Files\Amazon\AmazonCloudWatchAgent\config.json"
$cwfile2 = "C:\ProgramData\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent.json"
Write-Log-Line "$xDATE" " INFO"
Write-Log-Line "Stopping the Wildfly service" "INFO"
Start-Process -FilePath "C:\opt\wildfly\bin\service\service.bat" -ArgumentList @("stop") 
Write-Log-Line "Stopping the CloudwatchAgent" "INFO"
chdir "C:\Program Files\Amazon\AmazonCloudWatchAgent"
Invoke-Expression ".\amazon-cloudwatch-agent-ctl.ps1  -m ec2 -a stop"
Start-Sleep -s 15
Write-Log-Line "Deleting old files" "INFO"
Remove-Item $cwfile
Remove-Item $cwfile2
Remove-Item 'C:\opt\wildfly\logs\current_diagnosis.json'
Remove-Item 'C:\ProgramData\Amazon\AmazonCloudWatchAgent\Configs\*'
Remove-Item 'C:\ProgramData\Amazon\AmazonCloudWatchAgent\Logs\*.log'
Set-Location -Path "C:\Program Files\Amazon\AmazonCloudWatchAgent"
Write-Log-Line "Configuring CloudWatch config.json" "INFO"
$FileContent = @'
{
	"logs": {
		"logs_collected": {
        "files": {
            "collect_list": [
                {
                  "file_path": "C:\\opt\\wildfly\\logs\\current_diagnosis.json",
                  "log_group_name": "/aws/ec2/tars-${ENVIRONMENT}-messaging/current_diagnosis.json"
                }
            ]
        },
		"windows_events": {
				"collect_list": [
					{
						"event_format": "xml",
						"event_levels": [
							"VERBOSE",
							"INFORMATION",
							"WARNING",
							"ERROR",
							"CRITICAL"
						],
						"event_name": "System",
						"log_group_name": "System"
					}
				]
			}
		}
	},
	"metrics": {
		"append_dimensions": {
			"AutoScalingGroupName": "$${aws:AutoScalingGroupName}",
			"ImageId": "$${aws:ImageId}",
			"InstanceId": "$${aws:InstanceId}",
			"InstanceType": "$${aws:InstanceType}"
		},
		"metrics_collected": {
      "LogicalDisk": {
        "measurement": [
          "% Free Space"
          ],
          "metrics_collection_interval": 60,
          "resources": [
                  "*"
          ]
      },
			"Memory": {
				"measurement": [
					"% Committed Bytes In Use"
				],
				"metrics_collection_interval": 60
			},
			"Paging File": {
				"measurement": [
					"% Usage"
				],
				"metrics_collection_interval": 60,
				"resources": [
					"*"
				]
			},
      "Processor": {
        "measurement": [
            "% User Time",
            "% Idle Time",
            "% Interrupt Time"
        ],
        "metrics_collection_interval": 60,
        "resources": [
            "*"
        ]
      }
		}
	}
}
'@
$FileContent | Out-File $cwfile -Encoding Ascii -Force
Start-Sleep -s 2
Write-Log-Line "Starting the Wildfly service" "INFO"
Start-Process -FilePath "C:\opt\wildfly\bin\service\service.bat" -ArgumentList @("start")
chdir "C:\ProgramData\Amazon\AmazonCloudWatchAgent"
Copy-Item $cwfile -Destination $cwfile2
Start-Sleep -s 2
Write-Log-Line "Starting the CloudWatchAgent" "INFO"
chdir "C:\Program Files\Amazon\AmazonCloudWatchAgent"
Invoke-Expression ".\amazon-cloudwatch-agent-ctl.ps1  -m ec2 -a start" 
Write-Log-Line "Job done." "INFO"
</powershell>